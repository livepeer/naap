# ---------------------------------------------------------------------------
# Label PRs by size (lines changed) and warn on large PRs
# ---------------------------------------------------------------------------
name: PR Size

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  size-label:
    name: Apply size label
    runs-on: ubuntu-latest
    steps:
      - name: Calculate size and apply label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const linesChanged = pr.additions + pr.deletions;

            // Determine the appropriate size label
            const sizeLabels = [
              { label: 'size/XS',  max: 10   },
              { label: 'size/S',   max: 50   },
              { label: 'size/M',   max: 200  },
              { label: 'size/L',   max: 500  },
              { label: 'size/XL',  max: Infinity },
            ];

            const allSizeLabels = sizeLabels.map(s => s.label);
            const matched = sizeLabels.find(s => linesChanged <= s.max);
            const sizeLabel = matched.label;

            core.info(`PR #${pr.number}: +${pr.additions} -${pr.deletions} = ${linesChanged} lines → ${sizeLabel}`);

            // Remove any existing size labels that don't match
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            for (const existing of currentLabels) {
              if (allSizeLabels.includes(existing.name) && existing.name !== sizeLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: existing.name,
                });
              }
            }

            // Add the correct size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel],
            });

            // Post a warning comment for large PRs
            if (sizeLabel === 'size/L' || sizeLabel === 'size/XL') {
              const warningMsg =
                sizeLabel === 'size/XL'
                  ? `⚠️ **This PR is very large** (${linesChanged} lines changed). Please split it into smaller, focused PRs if possible.`
                  : `⚠️ **This PR is large** (${linesChanged} lines changed). Consider splitting it into smaller PRs for easier review.`;

              // Avoid duplicate bot comments
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });

              const marker = '<!-- pr-size-bot -->';
              const existing = comments.find(c => c.body.includes(marker));

              const body = `${marker}\n${warningMsg}`;

              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body,
                });
              }
            }
