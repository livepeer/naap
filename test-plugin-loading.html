<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plugin Loading Diagnostics</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
    h1 { color: #4CAF50; }
    .test { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 4px; }
    .pass { border-left: 4px solid #4CAF50; }
    .fail { border-left: 4px solid #f44336; }
    .warn { border-left: 4px solid #ff9800; }
    pre { background: #000; padding: 10px; overflow-x: auto; }
    button { background: #2196F3; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; border-radius: 4px; }
    button:hover { background: #1976D2; }
  </style>
</head>
<body>
  <h1>üîç NaaP Plugin Loading Diagnostics</h1>
  <button onclick="runAllTests()">Run All Tests</button>
  <button onclick="location.reload()">Refresh</button>
  <div id="results"></div>

  <script>
    const results = document.getElementById('results');

    function addResult(title, status, details) {
      const div = document.createElement('div');
      div.className = `test ${status}`;
      div.innerHTML = `
        <strong>${title}</strong><br>
        <pre>${details}</pre>
      `;
      results.appendChild(div);
    }

    async function test1() {
      try {
        const response = await fetch('http://localhost:4000/api/v1/base/plugins/personalized');
        if (!response.ok) {
          addResult('‚ùå Test 1: API Response', 'fail', `HTTP ${response.status}: ${response.statusText}`);
          return;
        }
        const data = await response.json();
        const plugins = data.plugins || [];
        addResult(
          '‚úÖ Test 1: API Returns Plugins', 
          'pass', 
          `Found ${plugins.length} plugins:\n${plugins.map(p => `  - ${p.name}: enabled=${p.enabled}, routes=${JSON.stringify(p.routes)}`).join('\n')}`
        );
        return plugins;
      } catch (e) {
        addResult('‚ùå Test 1: API Fetch Failed', 'fail', e.message);
        return [];
      }
    }

    async function test2(plugins) {
      const issues = [];
      for (const p of plugins) {
        if (!p.routes || p.routes.length === 0) {
          issues.push(`${p.name}: No routes`);
        }
        if (!p.remoteUrl) {
          issues.push(`${p.name}: No remoteUrl`);
        }
        if (!p.enabled) {
          issues.push(`${p.name}: Disabled`);
        }
      }
      if (issues.length > 0) {
        addResult('‚ö†Ô∏è  Test 2: Plugin Configuration Issues', 'warn', issues.join('\n'));
      } else {
        addResult('‚úÖ Test 2: All Plugins Properly Configured', 'pass', 'All plugins have routes, remoteUrl, and are enabled');
      }
    }

    async function test3(plugins) {
      results.innerHTML += '<h3>Test 3: remoteEntry.js Accessibility</h3>';
      for (const p of plugins) {
        try {
          const response = await fetch(p.remoteUrl);
          if (response.ok) {
            const text = await response.text();
            if (text.includes('moduleMap') || text.includes('__federation')) {
              addResult(`‚úÖ ${p.name}`, 'pass', `remoteEntry.js accessible and valid`);
            } else {
              addResult(`‚ö†Ô∏è  ${p.name}`, 'warn', `remoteEntry.js accessible but unexpected content`);
            }
          } else {
            addResult(`‚ùå ${p.name}`, 'fail', `HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (e) {
          addResult(`‚ùå ${p.name}`, 'fail', `Fetch failed: ${e.message}`);
        }
      }
    }

    async function test4() {
      // Check if shell can access plugin endpoint
      try {
        const response = await fetch('http://localhost:3000');
        if (response.ok) {
          addResult('‚úÖ Test 4: Shell Application', 'pass', 'Shell is accessible at localhost:3000');
        } else {
          addResult('‚ùå Test 4: Shell Application', 'fail', `HTTP ${response.status}`);
        }
      } catch (e) {
        addResult('‚ùå Test 4: Shell Application', 'fail', e.message);
      }
    }

    async function test5() {
      // Check plugin server
      try {
        const testUrls = [
          'http://localhost:3100/plugins/community/assets/remoteEntry.js',
          'http://localhost:3100/plugins/my-wallet/assets/remoteEntry.js',
        ];
        let passCount = 0;
        for (const url of testUrls) {
          try {
            const r = await fetch(url);
            if (r.ok) passCount++;
          } catch {}
        }
        if (passCount === testUrls.length) {
          addResult('‚úÖ Test 5: Plugin Server', 'pass', `Plugin server responding correctly`);
        } else {
          addResult('‚ö†Ô∏è  Test 5: Plugin Server', 'warn', `${passCount}/${testUrls.length} test URLs accessible`);
        }
      } catch (e) {
        addResult('‚ùå Test 5: Plugin Server', 'fail', e.message);
      }
    }

    async function runAllTests() {
      results.innerHTML = '<h2>Running diagnostics...</h2>';
      const plugins = await test1();
      if (plugins && plugins.length > 0) {
        await test2(plugins);
        await test3(plugins);
      }
      await test4();
      await test5();
      
      results.innerHTML += '<hr><h2>Summary</h2><p>Check results above. If all tests pass but plugins still don\'t show in sidebar, the issue is likely in the frontend React plugin loading logic.</p>';
      
      results.innerHTML += `
        <h3>Next Steps:</h3>
        <ol>
          <li>Open <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
          <li>Open DevTools Console (F12)</li>
          <li>Look for: <code>DynamicRoutes render: {pluginCount: X}</code></li>
          <li>If pluginCount is 0, check for console errors</li>
          <li>If pluginCount > 0 but plugins missing, check sidebar filtering logic</li>
        </ol>
      `;
    }

    // Run automatically on load
    runAllTests();
  </script>
</body>
</html>
