#!/bin/bash

# NAAP Platform - First-Run Setup
# Orchestrates the full environment from a fresh clone to running services.
#
# Usage: ./bin/setup.sh [options]
#   --skip-docker    Skip Docker/database setup (use if you have external DBs)
#   --skip-seed      Skip database seeding
#   --skip-build     Skip plugin builds
#   --start          Start all services after setup
#   --help           Show this help

set +e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
BLUE='\033[0;34m'; CYAN='\033[0;36m'; BOLD='\033[1m'; DIM='\033[2m'; NC='\033[0m'

log_info()    { echo -e "${BLUE}[INFO]${NC}  $1"; }
log_success() { echo -e "${GREEN}[OK]${NC}    $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC}  $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }
log_section() { echo -e "\n${CYAN}=== $1 ===${NC}"; }

SKIP_DOCKER=0
SKIP_SEED=0
SKIP_BUILD=0
AUTO_START=0

for arg in "$@"; do
  case "$arg" in
    --skip-docker) SKIP_DOCKER=1 ;;
    --skip-seed)   SKIP_SEED=1 ;;
    --skip-build)  SKIP_BUILD=1 ;;
    --start)       AUTO_START=1 ;;
    --help|-h)
      echo "NAAP Platform - First-Run Setup"
      echo ""
      echo "Usage: ./bin/setup.sh [options]"
      echo ""
      echo "Options:"
      echo "  --skip-docker    Skip Docker/database setup"
      echo "  --skip-seed      Skip database seeding"
      echo "  --skip-build     Skip plugin builds"
      echo "  --start          Start all services after setup"
      echo "  --help           Show this help"
      exit 0
      ;;
  esac
done

START_TIME=$(date +%s)

echo ""
echo -e "${BOLD}╔══════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}║       NAAP Platform - First-Run Setup        ║${NC}"
echo -e "${BOLD}╚══════════════════════════════════════════════╝${NC}"
echo ""

###############################################################################
# STEP 1: Dependency Checks
###############################################################################

log_section "Step 1/6: Checking Dependencies"

check_dep() {
  local cmd=$1 name=$2 install_hint=$3
  if command -v "$cmd" >/dev/null 2>&1; then
    local version
    version=$($cmd --version 2>/dev/null | head -1) || version="installed"
    log_success "$name found ($version)"
    return 0
  else
    log_error "$name not found."
    echo -e "  ${DIM}Install: $install_hint${NC}"
    return 1
  fi
}

DEPS_OK=true
check_dep node "Node.js" "https://nodejs.org/ (v20+ required)" || DEPS_OK=false
check_dep npm  "npm"     "Comes with Node.js" || DEPS_OK=false
check_dep git  "Git"     "https://git-scm.com/" || DEPS_OK=false

if [ "$SKIP_DOCKER" = "0" ]; then
  check_dep docker "Docker" "https://docs.docker.com/get-docker/" || DEPS_OK=false

  # Check Docker Compose (v2 is 'docker compose', v1 is 'docker-compose')
  if command -v docker >/dev/null 2>&1; then
    if docker compose version >/dev/null 2>&1; then
      log_success "Docker Compose found ($(docker compose version --short 2>/dev/null || echo 'v2'))"
    elif command -v docker-compose >/dev/null 2>&1; then
      log_success "Docker Compose found (v1)"
    else
      log_warn "Docker Compose not found. Some services may not start."
      echo -e "  ${DIM}Install: https://docs.docker.com/compose/install/${NC}"
    fi
  fi

  # Check Docker daemon is running
  if command -v docker >/dev/null 2>&1; then
    if ! docker info >/dev/null 2>&1; then
      log_error "Docker is installed but not running."
      echo -e "  ${DIM}Fix: Start Docker Desktop or run 'sudo systemctl start docker'${NC}"
      DEPS_OK=false
    fi
  fi
fi

if [ "$DEPS_OK" = false ]; then
  echo ""
  log_error "Missing dependencies. Install them and re-run this script."
  exit 1
fi

# Check Node.js version (require 20+)
NODE_MAJOR=$(node -v | sed 's/v\([0-9]*\).*/\1/')
if [ "$NODE_MAJOR" -lt 20 ]; then
  log_error "Node.js v20+ required (found $(node -v))."
  echo -e "  ${DIM}Fix: Use nvm to install a newer version: nvm install 20${NC}"
  exit 1
fi
log_success "Node.js version check passed ($(node -v))"

###############################################################################
# STEP 2: Environment File
###############################################################################

log_section "Step 2/6: Environment Configuration"

ENV_FILE="$ROOT_DIR/apps/web-next/.env.local"
if [ -f "$ENV_FILE" ]; then
  log_success ".env.local already exists"
else
  log_info "Creating .env.local with development defaults..."
  cat > "$ENV_FILE" << 'ENVEOF'
# NAAP Platform - Local Development Configuration
# Auto-generated by setup.sh - customize as needed

# Core
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXTAUTH_SECRET=dev-secret-change-me-in-production-min-32-chars

# Database (local Docker)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/naap?schema=public

# Backend services (local)
BASE_SVC_URL=http://localhost:4000
PLUGIN_SERVER_URL=http://localhost:3100
LIVEPEER_SVC_URL=http://localhost:4100
PIPELINE_GATEWAY_URL=http://localhost:4200
STORAGE_SVC_URL=http://localhost:4300
INFRASTRUCTURE_SVC_URL=http://localhost:4400

# Plugin backends (local) — ports match plugins/*/plugin.json → backend.devPort
GATEWAY_MANAGER_URL=http://localhost:4001
ORCHESTRATOR_MANAGER_URL=http://localhost:4002
CAPACITY_PLANNER_URL=http://localhost:4003
NETWORK_ANALYTICS_URL=http://localhost:4004
MARKETPLACE_URL=http://localhost:4005
COMMUNITY_URL=http://localhost:4006
DEVELOPER_API_URL=http://localhost:4007
WALLET_URL=http://localhost:4008
DASHBOARD_URL=http://localhost:4009
PLUGIN_PUBLISHER_URL=http://localhost:4010
DAYDREAM_VIDEO_URL=http://localhost:4111

# Caching (optional, uses in-memory fallback if not set)
# REDIS_URL=redis://localhost:6379

# Logging
LOG_LEVEL=info
DEBUG=false
ENVEOF
  log_success "Created $ENV_FILE"
fi

# Create base-svc .env
BASE_SVC_ENV="$ROOT_DIR/services/base-svc/.env"
if [ -f "$BASE_SVC_ENV" ]; then
  log_success "base-svc .env already exists"
else
  cat > "$BASE_SVC_ENV" << 'BEOF'
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/naap"
PORT=4000
BEOF
  log_success "Created base-svc .env"
fi

# Create plugin backend .env files
log_info "Checking plugin backend .env files..."
PLUGIN_ENVS_CREATED=0
declare -A PLUGIN_SCHEMA_MAP=(
  [capacity-planner]="plugin_capacity"
  [community]="plugin_community"
  [daydream-video]="plugin_daydream"
  [developer-api]="plugin_developer_api"
  [gateway-manager]="plugin_gateway"
  [marketplace]="plugin_marketplace"
  [my-dashboard]="plugin_dashboard"
  [my-wallet]="plugin_wallet"
  [network-analytics]="plugin_network_analytics"
  [orchestrator-manager]="plugin_orchestrator"
  [plugin-publisher]="plugin_publisher"
)
for pj in "$ROOT_DIR/plugins"/*/plugin.json; do
  [ -f "$pj" ] || continue
  pdir=$(dirname "$pj"); pname=$(basename "$pdir")
  [ -d "$pdir/backend" ] || continue
  plugin_env="$pdir/backend/.env"
  if [ ! -f "$plugin_env" ]; then
    schema="${PLUGIN_SCHEMA_MAP[$pname]:-public}"
    bp=$(grep -A5 '"backend"' "$pj" | grep -o '"devPort"[[:space:]]*:[[:space:]]*[0-9]*' | head -1 | grep -o '[0-9]*')
    cat > "$plugin_env" <<PEOF
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/naap?schema=${schema}"
PORT=${bp:-4099}
PEOF
    ((PLUGIN_ENVS_CREATED++)) || true
  fi
done
if [ $PLUGIN_ENVS_CREATED -gt 0 ]; then
  log_success "Created $PLUGIN_ENVS_CREATED plugin backend .env file(s)"
else
  log_success "All plugin backend .env files already exist"
fi

###############################################################################
# STEP 3: Install Dependencies
###############################################################################

log_section "Step 3/6: Installing Dependencies"

cd "$ROOT_DIR"
if [ -d "node_modules" ] && [ -f "package-lock.json" ]; then
  # Check if node_modules seems complete (root + at least one workspace)
  if [ -d "node_modules/.package-lock.json" ] || [ -d "node_modules/@naap" ]; then
    log_success "Dependencies already installed"
  else
    log_info "Installing dependencies (npm install)..."
    npm install 2>&1 | tail -3
    log_success "Dependencies installed"
  fi
else
  log_info "Installing dependencies (npm install)... This may take 1-2 minutes."
  npm install 2>&1 | tail -3
  log_success "Dependencies installed"
fi

###############################################################################
# STEP 4: Database Setup
###############################################################################

log_section "Step 4/6: Database Setup"

if [ "$SKIP_DOCKER" = "1" ]; then
  log_warn "Skipping Docker/database setup (--skip-docker)"
else
  # Start unified database container
  log_info "Starting database container..."
  CONTAINER_NAME="naap-db"
  RUNNING=$(docker ps -q -f name=$CONTAINER_NAME 2>/dev/null)

  if [ -z "$RUNNING" ]; then
    EXISTS=$(docker ps -aq -f name=$CONTAINER_NAME 2>/dev/null)
    if [ -n "$EXISTS" ]; then
      docker start $CONTAINER_NAME >/dev/null 2>&1
    else
      docker run -d --name $CONTAINER_NAME \
        -e POSTGRES_USER=postgres \
        -e POSTGRES_PASSWORD=postgres \
        -e POSTGRES_DB=naap \
        -p 5432:5432 \
        -v naap-db-data:/var/lib/postgresql/data \
        postgres:16-alpine >/dev/null 2>&1 || docker start $CONTAINER_NAME >/dev/null 2>&1
    fi
    log_info "Waiting for database to be ready..."
    for i in $(seq 1 30); do
      docker exec $CONTAINER_NAME pg_isready -U postgres >/dev/null 2>&1 && break
      sleep 1
    done
    if docker exec $CONTAINER_NAME pg_isready -U postgres >/dev/null 2>&1; then
      log_success "Database is ready"
    else
      log_error "Database failed to start within 30s."
      echo -e "  ${DIM}Debug: docker logs $CONTAINER_NAME${NC}"
      echo -e "  ${DIM}Fix: Ensure port 5432 is free: lsof -i :5432${NC}"
      exit 1
    fi
  else
    log_success "Database already running"
  fi

  # Ensure plugin schemas exist (e.g., plugin_community, plugin_wallet, etc.)
  log_info "Creating plugin database schemas..."
  if [ -f "$ROOT_DIR/docker/init-schemas.sql" ]; then
    docker exec -i $CONTAINER_NAME psql -U postgres -d naap < "$ROOT_DIR/docker/init-schemas.sql" >/dev/null 2>&1 && \
      log_success "Plugin schemas created" || \
      log_warn "Schema creation had warnings (may already exist)"
  fi

  # Single source of truth: packages/database/prisma/schema.prisma
  # This schema defines ALL tables (core + plugins) and generates the
  # Prisma client used by both seed scripts and backend services.
  FRONTEND_DIR="$ROOT_DIR/apps/web-next"
  log_info "Generating unified Prisma client and pushing schema..."
  if [ -f "$ROOT_DIR/packages/database/prisma/schema.prisma" ]; then
    cd "$ROOT_DIR/packages/database"

    # Generate Prisma client (picks up any new columns/models)
    npx prisma generate >/dev/null 2>&1 && \
      log_success "Unified Prisma client generated" || \
      log_warn "Prisma client generation had warnings"

    # Push schema to database (adds new columns/tables, preserves data)
    DATABASE_URL="postgresql://postgres:postgres@localhost:5432/naap" \
      npx prisma db push --skip-generate --accept-data-loss >/dev/null 2>&1 && \
      log_success "All database schemas synced (public + plugin schemas)" || \
      log_warn "Schema push had warnings (may be fine for first run)"
    cd "$ROOT_DIR"
  fi

  # Seed database (unless skipped)
  if [ "$SKIP_SEED" = "0" ]; then
    log_info "Seeding database..."
    if [ -f "$FRONTEND_DIR/prisma/seed.ts" ]; then
      cd "$FRONTEND_DIR"
      DATABASE_URL="postgresql://postgres:postgres@localhost:5432/naap?schema=public" \
        npx tsx prisma/seed.ts >/dev/null 2>&1 && \
        log_success "Database seeded (users, roles, plugins, marketplace)" || \
        log_warn "Database seeding had issues (may need tsx: npm install -g tsx)"
      cd "$ROOT_DIR"
    fi
    # Seed plugin databases if seed scripts exist
    if [ -f "$SCRIPT_DIR/db-seed.sh" ]; then
      bash "$SCRIPT_DIR/db-seed.sh" >/dev/null 2>&1 && \
        log_success "Plugin databases seeded" || \
        log_warn "Some plugin seeds skipped (non-critical)"
    fi
  else
    log_warn "Skipping database seeding (--skip-seed)"
  fi
fi

###############################################################################
# STEP 5: Build Plugins
###############################################################################

log_section "Step 5/6: Building Plugins"

if [ "$SKIP_BUILD" = "1" ]; then
  log_warn "Skipping plugin builds (--skip-build)"
else
  TO_BUILD=()
  for pj in "$ROOT_DIR/plugins"/*/plugin.json; do
    [ -f "$pj" ] || continue
    pdir=$(dirname "$pj")
    pname=$(basename "$pdir")
    if [ -d "$pdir/frontend" ] && [ ! -d "$pdir/frontend/dist/production" ]; then
      TO_BUILD+=("$pname")
    fi
  done

  if [ ${#TO_BUILD[@]} -eq 0 ]; then
    log_success "All plugins already built"
  else
    log_info "Building ${#TO_BUILD[@]} plugins: ${TO_BUILD[*]}"
    FAILED=0
    for p in "${TO_BUILD[@]}"; do
      [ -d "$ROOT_DIR/plugins/$p/frontend" ] || continue
      log_info "  Building $p..."
      cd "$ROOT_DIR/plugins/$p/frontend"
      if npm run build >/dev/null 2>&1; then
        log_success "  Built $p"
      else
        ((FAILED++)) || true
        log_warn "  Build failed for $p (non-critical, can build later)"
      fi
    done
    cd "$ROOT_DIR"
    if [ $FAILED -gt 0 ]; then
      log_warn "$FAILED plugin(s) failed to build. Run 'npm run build:plugins' to retry."
    else
      log_success "All plugins built successfully"
    fi
  fi
fi

###############################################################################
# STEP 6: Verification
###############################################################################

log_section "Step 6/6: Verification"

# Check critical files exist
CHECKS_PASSED=true
for f in "apps/web-next/package.json" "services/base-svc/package.json" "services/plugin-server/package.json"; do
  if [ -f "$ROOT_DIR/$f" ]; then
    log_success "Found $f"
  else
    log_error "Missing $f"
    CHECKS_PASSED=false
  fi
done

if [ -d "$ROOT_DIR/node_modules/@naap" ]; then
  log_success "Workspace packages linked"
else
  log_warn "Workspace packages may not be linked. Run 'npm install' again."
fi

###############################################################################
# DONE
###############################################################################

ELAPSED=$(( $(date +%s) - START_TIME ))

echo ""
echo -e "${BOLD}╔══════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}║          Setup Complete! (${ELAPSED}s)              ║${NC}"
echo -e "${BOLD}╚══════════════════════════════════════════════╝${NC}"
echo ""

echo -e "${BOLD}Login Credentials (all passwords: livepeer):${NC}"
echo ""
echo -e "  ${CYAN}admin@livepeer.org${NC}        System Admin"
echo -e "  ${CYAN}viewer@livepeer.org${NC}       Read-only Viewer"
echo -e "  ${DIM}gateway@livepeer.org      Gateway Manager Admin${NC}"
echo -e "  ${DIM}community@livepeer.org    Community Admin${NC}"
echo -e "  ${DIM}developer@livepeer.org    Developer API Admin${NC}"
echo -e "  ${DIM}...and 7 more plugin admins (same password)${NC}"
echo ""

if [ "$AUTO_START" = "1" ]; then
  log_info "Starting NAAP Platform..."
  exec "$SCRIPT_DIR/start.sh" start --all
else
  echo -e "${BOLD}Next steps:${NC}"
  echo ""
  echo "  1. Start the platform:"
  echo -e "     ${CYAN}./bin/start.sh start --all${NC}      # Everything"
  echo -e "     ${CYAN}./bin/start.sh${NC}                  # Shell + core only"
  echo ""
  echo "  2. Open in browser:"
  echo -e "     ${CYAN}http://localhost:3000${NC}"
  echo -e "     Login: ${CYAN}admin@livepeer.org${NC} / ${CYAN}livepeer${NC}"
  echo ""
  echo "  3. Develop a plugin:"
  echo -e "     ${CYAN}./bin/start.sh dev my-dashboard${NC}"
  echo ""
  echo "  4. Check status:"
  echo -e "     ${CYAN}./bin/start.sh status${NC}"
  echo ""
  echo -e "  ${DIM}Full docs: docs/QUICKSTART.md${NC}"
  echo ""
fi
