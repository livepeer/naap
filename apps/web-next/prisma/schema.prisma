// Prisma schema for web-next (Next.js API Routes)
// Mirrors base-svc schema for auth and user management
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")           // Pooled connection for queries
  directUrl = env("DATABASE_URL_UNPOOLED")  // Direct connection for migrations
}

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  passwordHash  String?
  emailVerified DateTime?
  address       String?   @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  lockedUntil   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  config            UserConfig?
  sessions          Session[]
  oauthAccounts     OAuthAccount[]
  loginAttempts     LoginAttempt[]
  userRoles         UserRole[]
  ownedTeams        Team[]        @relation("TeamOwner")
  teamMemberships   TeamMember[]
  pluginPreferences UserPluginPreference[]
  tenantInstalls    TenantPluginInstall[]
  pluginReviews     PluginReview[]
  feedbacks         Feedback[]
}

model Team {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  avatarUrl   String?
  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members        TeamMember[]
  pluginInstalls TeamPluginInstall[]

  @@index([ownerId])
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member")
  invitedBy String?
  joinedAt  DateTime @default(now())

  pluginAccess  TeamMemberPluginAccess[]
  pluginConfigs TeamMemberPluginConfig[]

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
  @@index([teamId, role])
}

model LoginAttempt {
  id        String   @id @default(uuid())
  email     String
  ipAddress String?
  success   Boolean  @default(false)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
}

model OAuthAccount {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model UserConfig {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme        String   @default("dark")
  preferences  Json?    @default("{}")
  debugEnabled Boolean  @default(true)
  debugDisabledBy String?
  debugDisabledAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Role {
  id          String     @id @default(uuid())
  name        String     @unique
  displayName String
  description String?
  permissions Json
  canAssign   String[]   @default([])
  inherits    String[]   @default([])
  scope       String     @default("system")
  pluginName  String?
  isSystem    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  userRoles   UserRole[]

  @@index([scope])
  @@index([pluginName])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  grantedBy String?
  grantedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
}

// =============================================================================
// Gateway Manager Plugin Models
// =============================================================================

model Gateway {
  id                      String   @id @default(uuid())
  address                 String   @unique
  operatorName            String
  serviceUri              String
  region                  String
  ip                      String?
  status                  String   @default("online") // online, offline, degraded
  uptime                  Float    @default(100.0)
  latencyP50              Int      @default(0)
  latencyP99              Int      @default(0)
  jobsPerMinute           Int      @default(0)
  deposit                 String   @default("0") // Using String for BigInt
  reserve                 String   @default("0")
  supportedPipelines      String[] @default([])
  connectedOrchestrators  Int      @default(0)
  version                 String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  orchestratorConnections GatewayOrchestratorConnection[]
  performanceMetrics      GatewayPerformanceMetric[]
  configurations          GatewayConfig[]
  
  @@index([status])
  @@index([region])
  @@index([address])
  @@map("gateway_gateways")
}

model GatewayOrchestratorConnection {
  id                  String   @id @default(uuid())
  gatewayId           String
  gateway             Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  orchestratorAddress String
  latencyScore        Float
  successRate         Float
  jobsSent            Int      @default(0)
  price               String   // Using String for BigInt
  status              String   @default("active") // active, blocked, trusted
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([gatewayId])
  @@index([orchestratorAddress])
  @@unique([gatewayId, orchestratorAddress])
  @@map("gateway_orchestrator_connections")
}

model GatewayPerformanceMetric {
  id        String   @id @default(uuid())
  gatewayId String
  gateway   Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  metric    String   // latency, throughput, success_rate, etc.
  value     Float
  timestamp DateTime @default(now())
  metadata  Json?
  
  @@index([gatewayId, timestamp])
  @@index([timestamp])
  @@map("gateway_performance_metrics")
}

model GatewayConfig {
  id            String   @id @default(uuid())
  gatewayId     String   @unique
  gateway       Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  slaConfig     Json?    // SLA formula configuration
  pricingConfig Json?    // Pricing configuration
  networkConfig Json?    // Network bind addresses
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("gateway_configs")
}

// =============================================================================
// Developer API Plugin Models
// =============================================================================

model DeveloperApiKey {
  id          String    @id @default(uuid())
  userId      String
  projectName String
  modelId     String
  modelName   String
  gatewayId   String
  gatewayName String
  keyHash     String    @unique
  status      String    @default("active") // active, revoked
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?
  
  @@index([userId])
  @@index([status])
  @@map("developer_api_keys")
}

// =============================================================================
// My Wallet Plugin Models
// =============================================================================

model WalletConnection {
  id        String   @id @default(uuid())
  userId    String   @unique
  address   String
  chainId   Int
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([address])
  @@index([userId])
  @@map("wallet_connections")
}

model WalletTransactionLog {
  id          String    @id @default(uuid())
  userId      String
  address     String
  txHash      String    @unique
  type        String    // stake, unstake, claim, transfer, other
  status      String    @default("pending") // pending, confirmed, failed
  chainId     Int
  value       String?   // Amount in wei (stored as string for precision)
  gasUsed     String?   // Gas used in wei
  gasPrice    String?   // Gas price in wei
  blockNumber Int?
  toAddress   String?   // Recipient address for transfers
  timestamp   DateTime  @default(now())
  confirmedAt DateTime?
  metadata    Json?     // Additional transaction-specific data
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId, timestamp])
  @@index([address, timestamp])
  @@index([txHash])
  @@index([status])
  @@map("wallet_transaction_logs")
}

model WalletStakingState {
  id              String   @id @default(uuid())
  address         String   @unique
  chainId         Int
  stakedAmount    String   @default("0")  // LPT in wei
  delegatedTo     String?                  // Orchestrator address
  pendingRewards  String   @default("0")  // LPT in wei
  pendingFees     String   @default("0")  // ETH in wei
  startRound      String?                  // Round when staking started
  lastClaimRound  String?                  // Last round rewards were claimed
  lastSynced      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([address])
  @@index([delegatedTo])
  @@map("wallet_staking_states")
}

model WalletOrchestrator {
  id            String   @id @default(uuid())
  address       String   @unique
  chainId       Int
  name          String?
  serviceUri    String?
  totalStake    String   @default("0")
  rewardCut     Int      @default(0)      // Percentage (0-100)
  feeShare      Int      @default(0)      // Percentage (0-100)
  isActive      Boolean  @default(true)
  lastSynced    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([chainId, isActive])
  @@index([totalStake])
  @@map("wallet_orchestrators")
}

model WalletSettings {
  id              String   @id @default(uuid())
  userId          String   @unique
  defaultNetwork  String   @default("arbitrum-one")
  autoConnect     Boolean  @default(true)
  showTestnets    Boolean  @default(false)
  gasStrategy     String   @default("standard") // slow, standard, fast
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("wallet_settings")
}

// =============================================================================
// My Dashboard Plugin Models
// =============================================================================

model Dashboard {
  id          String   @id @default(uuid())
  metabaseId  Int      // Metabase numeric dashboard ID
  entityId    String?  // Optional Metabase entity ID
  name        String
  description String?
  thumbnail   String?
  isDefault   Boolean  @default(false)
  order       Int      @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isDefault])
  @@index([order])
  @@index([metabaseId])
  @@map("dashboard_dashboards")
}

model DashboardUserPreference {
  id          String   @id @default(uuid())
  userId      String
  dashboardId String
  pinned      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, dashboardId])
  @@index([userId])
  @@map("dashboard_user_preferences")
}

model DashboardPluginConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
  
  @@map("dashboard_plugin_configs")
}

// =============================================================================
// Community Plugin Models
// =============================================================================

model CommunityUser {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  reputation    Int      @default(0)
  level         Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  posts          CommunityPost[]
  comments       CommunityComment[]
  votes          CommunityVote[]
  reputationLogs CommunityReputationLog[]
  badges         CommunityUserBadge[]

  @@index([walletAddress])
  @@index([reputation])
  @@map("community_users")
}

model CommunityPost {
  id               String   @id @default(uuid())
  authorId         String
  author           CommunityUser @relation(fields: [authorId], references: [id], onDelete: Cascade)
  title            String
  content          String
  postType         String   @default("DISCUSSION") // QUESTION, DISCUSSION, ANNOUNCEMENT, SHOWCASE
  category         String   @default("GENERAL")    // GENERAL, ORCHESTRATORS, etc.
  status           String   @default("OPEN")       // OPEN, CLOSED, ARCHIVED
  upvotes          Int      @default(0)
  viewCount        Int      @default(0)
  commentCount     Int      @default(0)
  isSolved         Boolean  @default(false)
  acceptedAnswerId String?
  isPinned         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  comments  CommunityComment[]
  votes     CommunityVote[]
  postTags  CommunityPostTag[]

  @@index([authorId])
  @@index([category])
  @@index([postType])
  @@index([isSolved])
  @@index([createdAt])
  @@index([upvotes])
  @@map("community_posts")
}

model CommunityComment {
  id         String   @id @default(uuid())
  postId     String
  post       CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId   String
  author     CommunityUser @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content    String
  upvotes    Int      @default(0)
  isAccepted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  votes CommunityVote[]

  @@index([postId])
  @@index([authorId])
  @@index([isAccepted])
  @@map("community_comments")
}

model CommunityVote {
  id         String   @id @default(uuid())
  userId     String
  user       CommunityUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetType String   // POST, COMMENT
  targetId   String
  value      Int      @default(1)
  createdAt  DateTime @default(now())

  post      CommunityPost?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?
  comment   CommunityComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?

  @@unique([userId, targetType, targetId])
  @@index([targetType, targetId])
  @@map("community_votes")
}

model CommunityTag {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String   @default("#6b7280")
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())

  postTags CommunityPostTag[]

  @@index([slug])
  @@index([usageCount])
  @@map("community_tags")
}

model CommunityPostTag {
  id      String @id @default(uuid())
  postId  String
  post    CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId   String
  tag     CommunityTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@map("community_post_tags")
}

model CommunityReputationLog {
  id         String   @id @default(uuid())
  userId     String
  user       CommunityUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String   // POST_CREATED, POST_UPVOTED, etc.
  points     Int
  sourceType String?
  sourceId   String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("community_reputation_logs")
}

model CommunityBadge {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String
  icon        String
  color       String   @default("#6b7280")
  criteria    String
  threshold   Int      @default(1)
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges CommunityUserBadge[]

  @@index([slug])
  @@map("community_badges")
}

model CommunityUserBadge {
  id        String   @id @default(uuid())
  userId    String
  user      CommunityUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     CommunityBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("community_user_badges")
}

// =============================================================================
// Daydream Video Plugin Models
// =============================================================================

model DaydreamSettings {
  id              String   @id @default(uuid())
  userId          String   @unique
  apiKey          String?
  defaultPrompt   String   @default("superman")
  defaultSeed     Int      @default(42)
  negativePrompt  String   @default("blurry, low quality, flat, 2d")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("daydream_settings")
}

model DaydreamSession {
  id          String    @id @default(uuid())
  userId      String
  streamId    String
  playbackId  String?
  whipUrl     String?
  prompt      String?
  seed        Int?
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  durationMins Float?
  status      String    @default("active") // active, ended

  @@index([userId])
  @@index([streamId])
  @@index([status])
  @@map("daydream_sessions")
}

// =============================================================================
// Core Platform & Marketplace Models (Legacy Port)
// =============================================================================

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkflowPlugin {
  id             String   @id @default(uuid())
  name           String   @unique
  displayName    String
  version        String
  remoteUrl      String
  bundleUrl      String?  // CDN UMD bundle URL
  stylesUrl      String?  // CDN styles URL
  globalName     String?  // UMD global name (e.g., NaapPluginMarketplace)
  deploymentType String?  @default("cdn") // 'cdn' | 'container'
  routes         String[]
  enabled        Boolean  @default(true)
  order          Int      @default(0)
  icon           String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([enabled, order])
}

model UserPluginPreference {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pluginName String
  enabled   Boolean  @default(true)
  order     Int?
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, pluginName])
  @@index([userId])
}

model Publisher {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String?
  website     String?
  email       String   @unique
  githubOrg   String?  @unique
  githubUser  String?  @unique
  avatarUrl   String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  packages    PluginPackage[] @relation("PackagePublisher")
  tokens      ApiToken[]

  @@index([githubOrg])
  @@index([githubUser])
}

model PluginPackage {
  id            String   @id @default(uuid())
  name          String   @unique
  displayName   String
  description   String?
  category      String   @default("other")
  author        String?
  authorEmail   String?
  repository    String?
  githubRepo    String?
  license       String?
  keywords      String[]
  icon          String?
  downloads     Int      @default(0)
  rating        Float?
  deprecated    Boolean  @default(false)
  isCore        Boolean  @default(false)
  publishStatus String   @default("draft")
  publisherId   String?
  publisher     Publisher? @relation("PackagePublisher", fields: [publisherId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  versions      PluginVersion[]
  installations PluginInstallation[]
  deployment    PluginDeployment?
  reviews       PluginReview[]

  @@index([category])
  @@index([deprecated])
  @@index([publisherId])
  @@index([publishStatus])
  @@index([isCore])
}

model PluginReview {
  id          String   @id @default(uuid())
  packageId   String
  package     PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating      Int      // 1-5 star rating
  comment     String?  // Optional review comment
  displayName String?  // Cached display name at time of review
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([packageId, userId]) // One review per user per plugin
  @@index([packageId, createdAt])
  @@index([userId])
}

model PluginVersion {
  id            String   @id @default(uuid())
  packageId     String
  package       PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  version       String
  manifest      Json
  frontendUrl   String?
  backendImage  String?
  releaseNotes  String?
  deprecated    Boolean        @default(false)
  deprecationMsg String?
  downloads     Int            @default(0)
  publishedAt   DateTime       @default(now())

  // CDN deployment fields (for UMD bundles)
  bundleUrl     String?        // CDN URL for the UMD bundle
  stylesUrl     String?        // CDN URL for styles (optional)
  bundleHash    String?        // Content hash for cache validation
  bundleSize    Int?           // Bundle size in bytes
  deploymentType String?       @default("cdn") // cdn, container

  installations  PluginInstallation[]
  deployments    PluginDeployment[]
  pinnedByTeams  TeamPluginInstall[] @relation("PinnedVersion")

  @@unique([packageId, version])
  @@index([packageId, publishedAt])
  @@index([deploymentType])
}

model PluginInstallation {
  id          String   @id @default(uuid())
  packageId   String
  package     PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  versionId   String
  version     PluginVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  status      String   @default("pending")
  
  containerPort Int?
  databaseName  String?
  frontendPort  Int?
  
  config      Json?
  
  installedAt DateTime?
  lastHealthCheck DateTime?
  healthStatus String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([packageId])
  @@index([status])
}

model PluginDeployment {
  id              String   @id @default(uuid())
  packageId       String   @unique
  package         PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  versionId       String
  version         PluginVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  
  status          String   @default("pending")
  
  frontendUrl     String?
  backendUrl      String?
  containerPort   Int?
  databaseSchema  String?
  
  // CDN deployment fields
  bundleUrl       String?  // CDN URL for UMD bundle (preferred over frontendUrl for CDN plugins)
  stylesUrl       String?  // CDN URL for styles
  bundleHash      String?  // Content hash for cache busting
  bundleSize      Int?     // Bundle size in bytes
  deploymentType  String   @default("cdn") // cdn, container
  
  activeInstalls  Int      @default(0)
  
  deployedAt      DateTime?
  lastHealthCheck DateTime?
  healthStatus    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  tenantInstalls  TenantPluginInstall[]
  teamInstalls    TeamPluginInstall[]

  // Blue-green deployment slots
  slots           PluginDeploymentSlot[]

  @@index([status])
  @@index([healthStatus])
  @@index([deploymentType])
}

model TenantPluginInstall {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deploymentId    String
  deployment      PluginDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  
  status          String   @default("active")
  installedAt     DateTime @default(now())
  
  enabled         Boolean  @default(true)
  order           Int      @default(0)
  pinned          Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  config          TenantPluginConfig?
  
  @@unique([userId, deploymentId])
  @@index([userId, status])
  @@index([deploymentId])
}

// Tenant-isolated configuration
model TenantPluginConfig {
  id              String   @id @default(uuid())
  tenantInstallId String   @unique
  tenantInstall   TenantPluginInstall @relation(fields: [tenantInstallId], references: [id], onDelete: Cascade)
  
  settings        Json     @default("{}")
  secrets         Json?    // Encrypted secrets
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// =============================================================================
// Plugin Configuration Model
// =============================================================================

model PluginConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// Team Plugin Management Models
// =============================================================================

model TeamPluginInstall {
  id              String   @id @default(uuid())
  teamId          String
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  deploymentId    String
  deployment      PluginDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  installedBy     String
  status          String   @default("active")
  enabled         Boolean  @default(true)

  pinnedVersionId String?
  pinnedVersion   PluginVersion? @relation("PinnedVersion", fields: [pinnedVersionId], references: [id], onDelete: SetNull)

  sharedConfig    Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  memberAccess    TeamMemberPluginAccess[]
  memberConfigs   TeamMemberPluginConfig[]

  @@unique([teamId, deploymentId])
  @@index([teamId])
  @@index([deploymentId])
}

model TeamMemberPluginAccess {
  id              String   @id @default(uuid())
  memberId        String
  member          TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pluginInstallId String
  pluginInstall   TeamPluginInstall @relation(fields: [pluginInstallId], references: [id], onDelete: Cascade)
  
  visible         Boolean  @default(true)
  canUse          Boolean  @default(true)
  canConfigure    Boolean  @default(false)
  pluginRole      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([memberId, pluginInstallId])
  @@index([memberId])
  @@index([pluginInstallId])
}

model TeamMemberPluginConfig {
  id              String   @id @default(uuid())
  memberId        String
  member          TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pluginInstallId String
  pluginInstall   TeamPluginInstall @relation(fields: [pluginInstallId], references: [id], onDelete: Cascade)
  
  personalConfig  Json     @default("{}")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([memberId, pluginInstallId])
  @@index([memberId])
  @@index([pluginInstallId])
}

// =============================================================================
// Admin/Secrets Models
// =============================================================================

model SecretVault {
  id             String   @id @default(uuid())
  key            String   @unique
  encryptedValue String
  iv             String
  description    String?
  scope          String   @default("global")
  createdBy      String?
  rotatedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([scope])
}

model APIKeyMapping {
  id              String   @id @default(uuid())
  pluginName      String
  integrationType String
  secretKey       String
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([pluginName, integrationType])
  @@index([secretKey])
}

model IntegrationConfig {
  id          String   @id @default(uuid())
  type        String   @unique
  displayName String
  configured  Boolean  @default(false)
  credentials Json?
  options     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PluginIntegrationPermission {
  id              String   @id @default(uuid())
  pluginName      String
  integrationType String
  granted         Boolean  @default(false)
  grantedAt       DateTime?
  grantedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([pluginName, integrationType])
  @@index([pluginName])
}

// =============================================================================
// Feedback Models
// =============================================================================

model Feedback {
  id          String   @id @default(uuid())
  type        String   // bug, feature, general
  title       String
  description String
  status      String   @default("open") // open, investigating, roadmap, released, closed
  releaseTag  String?  // e.g. "v1.2.0" â€“ set when status = released
  adminNote   String?  // internal admin note
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userEmail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("feedback")
}

model FeedbackConfig {
  id            String   @id @default(uuid())
  githubIssueUrl String  @default("")
  discordUrl    String   @default("")
  updatedBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("feedback_config")
}

// =============================================================================
// Observability Models
// =============================================================================

model HistoricalStat {
  id        String   @id @default(uuid())
  service   String
  metric    String
  value     Float
  timestamp DateTime @default(now())
  metadata  Json?
  
  @@index([service, metric, timestamp])
  @@index([timestamp])
}

model JobFeed {
  id            String   @id @default(uuid())
  gatewayId     String
  gatewayAddress String?
  jobId         String
  jobType       String
  status        String
  latencyMs     Int?
  priceWei      String?
  timestamp     DateTime @default(now())
  metadata      Json?
  indexedAt     DateTime @default(now())
  
  @@index([gatewayId, timestamp])
  @@index([jobType, timestamp])
  @@index([status, timestamp])
  @@index([timestamp])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  resource    String
  resourceId  String?
  userId      String?
  ipAddress   String?
  userAgent   String?
  details     Json?
  status      String   @default("success")
  errorMsg    String?
  createdAt   DateTime @default(now())
  
  @@index([action, createdAt])
  @@index([resource, resourceId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

// =============================================================================
// Plugin Lifecycle Models
// =============================================================================

model PluginLifecycleEvent {
  id            String   @id @default(uuid())
  pluginName    String
  version       String?
  action        String
  fromStatus    String?
  toStatus      String
  initiatedBy   String?
  details       Json?
  error         String?
  duration      Int?
  createdAt     DateTime @default(now())
  
  @@index([pluginName, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

model PluginMigration {
  id            String   @id @default(uuid())
  pluginName    String
  version       String
  migrationName String
  status        String   @default("pending")
  appliedAt     DateTime?
  completedAt   DateTime?
  error         String?
  checksum      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([pluginName, migrationName])
  @@index([pluginName, version])
  @@index([status])
}

// =============================================================================
// Publisher CI/CD Models
// =============================================================================

model ApiToken {
  id            String    @id @default(uuid())
  name          String
  tokenHash     String    @unique
  tokenPrefix   String
  publisherId   String
  publisher     Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  scopes        String[]
  expiresAt     DateTime?
  lastUsedAt    DateTime?
  revokedAt     DateTime?
  createdAt     DateTime  @default(now())
  
  @@index([tokenHash])
  @@index([publisherId])
}

model WebhookSecret {
  id            String   @id @default(uuid())
  publisherId   String
  provider      String
  secretHash    String
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([publisherId, provider])
}

// =============================================================================
// Blue-Green Deployment Infrastructure
// =============================================================================

// Deployment slot for blue-green deployments
// Each deployment has two slots (blue/green) for zero-downtime updates
model PluginDeploymentSlot {
  id              String   @id @default(uuid())
  deploymentId    String
  deployment      PluginDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  slot            String   // "blue" | "green"
  version         String   // Version deployed to this slot
  status          String   @default("inactive") // active, inactive, deploying, failed, draining

  trafficPercent  Int      @default(0) // 0-100, percentage of traffic routed here

  // Infrastructure URLs
  frontendUrl     String?  // CDN URL for this slot's frontend bundle
  backendUrl      String?  // Container URL for this slot's backend

  // Health tracking
  healthStatus    String?  // healthy, unhealthy, unknown
  lastHealthCheck DateTime?
  healthCheckFailures Int  @default(0) // Consecutive failures count

  // Metadata
  deployedAt      DateTime?
  deployedBy      String?  // User who initiated deployment
  metadata        Json?    // Additional deployment metadata

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([deploymentId, slot])
  @@index([deploymentId])
  @@index([status])
  @@index([healthStatus])
}

// Deployment events for audit trail and history
model DeploymentEvent {
  id              String   @id @default(uuid())
  deploymentId    String
  type            String   // deploy_start, deploy_complete, health_check, traffic_shift, rollback, failure

  // Slot transition details
  fromSlot        String?  // Source slot (for traffic shifts)
  toSlot          String?  // Target slot
  fromVersion     String?  // Previous version
  toVersion       String?  // New version

  // Traffic details
  trafficPercent  Int?     // Traffic percentage after this event

  // Status
  status          String   @default("success") // success, failure, in_progress
  error           String?  // Error message if failed

  // Actor
  initiatedBy     String?  // User ID or 'system' for auto-rollback

  // Additional context
  metadata        Json?    // Strategy config, health check results, etc.
  duration        Int?     // Duration in milliseconds

  createdAt       DateTime @default(now())

  @@index([deploymentId])
  @@index([type])
  @@index([createdAt])
  @@index([deploymentId, createdAt])
}

// Time-series metrics for plugin monitoring
model PluginMetrics {
  id              String   @id @default(uuid())
  deploymentId    String
  slot            String?  // Optional slot identifier for per-slot metrics
  timestamp       DateTime @default(now())

  // Request metrics
  requestCount    Int      @default(0)
  errorCount      Int      @default(0)

  // Latency percentiles (in milliseconds)
  latencyP50      Float?
  latencyP95      Float?
  latencyP99      Float?
  latencyAvg      Float?

  // User metrics
  activeUsers     Int      @default(0)
  uniqueSessions  Int      @default(0)

  // Resource usage
  memoryUsageMb   Float?
  cpuUsagePercent Float?

  // Aggregation period
  periodSeconds   Int      @default(60) // Aggregation window (60s, 300s, 3600s)

  @@index([deploymentId, timestamp])
  @@index([deploymentId, slot, timestamp])
  @@index([timestamp])
}

// Alert configuration for plugin monitoring
model PluginAlert {
  id              String   @id @default(uuid())
  deploymentId    String
  name            String   // Alert name (e.g., "High Error Rate")
  description     String?

  // Condition
  metric          String   // error_rate, latency_p99, health_check, cpu_usage, memory_usage
  operator        String   // gt, gte, lt, lte, eq
  threshold       Float    // Threshold value
  duration        Int      @default(60) // Duration in seconds condition must be true

  // Severity and actions
  severity        String   @default("warning") // critical, warning, info
  autoRollback    Boolean  @default(false) // Trigger rollback on alert

  // Notification channels (JSON array of channel configs)
  // e.g., [{"type": "slack", "webhook": "..."}, {"type": "email", "address": "..."}]
  channels        Json     @default("[]")

  // State
  enabled         Boolean  @default(true)
  lastTriggeredAt DateTime?
  lastResolvedAt  DateTime?
  triggerCount    Int      @default(0)

  // Cooldown to prevent alert storms
  cooldownSeconds Int      @default(300) // 5 minutes between alerts

  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([deploymentId, name])
  @@index([deploymentId])
  @@index([enabled])
  @@index([severity])
}
