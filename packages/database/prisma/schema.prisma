// ============================================
// UNIFIED NAAP DATABASE SCHEMA
// ============================================
// This schema consolidates all platform and plugin models
// into a single source of truth.
//
// Architecture:
// - Uses PostgreSQL schemas for logical separation
// - 'public' schema: Core platform models
// - Plugin-specific tables use prefixes to avoid conflicts
//
// Migrations: Use 'prisma db push' for development
// Production: Use 'prisma migrate deploy'

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/client"
  // Include all common production targets: Vercel, Docker Alpine, AWS Lambda, etc.
  binaryTargets   = ["native", "darwin-arm64", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x", "rhel-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["multiSchema", "fullTextSearch"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
  schemas   = ["public", "plugin_community", "plugin_wallet", "plugin_dashboard", "plugin_daydream", "plugin_gateway", "plugin_capacity", "plugin_developer_api"]
}

// ============================================
// CORE PLATFORM - AUTHENTICATION & USERS
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  passwordHash  String?
  emailVerified DateTime?
  address       String?   @unique // Wallet address for Web3 auth
  displayName   String?
  avatarUrl     String?
  bio           String?
  lockedUntil   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Core relations
  config            UserConfig?
  sessions          Session[]
  pluginPreferences UserPluginPreference[]
  oauthAccounts     OAuthAccount[]
  loginAttempts     LoginAttempt[]
  tenantInstalls    TenantPluginInstall[]
  roles             UserRole[]

  // Team relations
  ownedTeams      Team[]       @relation("TeamOwner")
  teamMemberships TeamMember[]

  // Platform relations
  pluginReviews    PluginReview[]
  feedbacks        Feedback[]

  // Plugin relations - Community
  communityProfile CommunityProfile?

  // Plugin relations - Wallet
  walletConnection WalletConnection?

  @@schema("public")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  email     String
  ipAddress String?
  success   Boolean  @default(false)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@schema("public")
}

model OAuthAccount {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@schema("public")
}

model UserConfig {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme           String    @default("dark")
  preferences     Json?     @default("{}")
  debugEnabled    Boolean   @default(true)
  debugDisabledBy String?
  debugDisabledAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@schema("public")
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@schema("public")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@schema("public")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - BILLING PROVIDERS
// ============================================

model BillingProvider {
  id          String   @id @default(uuid())
  slug        String   @unique
  displayName String
  description String?
  icon        String?
  authType    String   @default("oauth")
  enabled     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  devApiKeys DevApiKey[]

  @@index([enabled])
  @@schema("public")
}

model BillingProviderOAuthSession {
  loginSessionId    String    @id
  state             String    @unique
  providerSlug      String
  gatewayNonce      String
  gatewayInstanceId String?
  naapUserId        String?
  status            String    @default("pending")
  accessToken       String?
  providerUserId    String?
  redeemedAt        DateTime?
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([expiresAt])
  @@index([providerSlug])
  @@index([naapUserId])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - TEAMS & ORGANIZATIONS
// ============================================

model Team {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  avatarUrl   String?
  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members        TeamMember[]
  pluginInstalls TeamPluginInstall[]

  @@index([ownerId])
  @@schema("public")
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member")
  invitedBy String?
  joinedAt  DateTime @default(now())

  pluginAccess  TeamMemberPluginAccess[]
  pluginConfigs TeamMemberPluginConfig[]

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
  @@index([teamId, role])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - RBAC
// ============================================

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String?
  permissions Json
  canAssign   String[] @default([])
  inherits    String[] @default([])
  scope       String   @default("system")
  pluginName  String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userRoles UserRole[]

  @@index([scope])
  @@index([pluginName])
  @@schema("public")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantedBy String?
  grantedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - MONITORING & ANALYTICS
// ============================================

model HistoricalStat {
  id        String   @id @default(uuid())
  service   String
  metric    String
  value     Float
  timestamp DateTime @default(now())
  metadata  Json?

  @@index([service, metric, timestamp])
  @@index([timestamp])
  @@schema("public")
}

model JobFeed {
  id             String   @id @default(uuid())
  gatewayId      String
  gatewayAddress String?
  jobId          String
  jobType        String
  status         String
  latencyMs      Int?
  priceWei       String?
  timestamp      DateTime @default(now())
  metadata       Json?
  indexedAt      DateTime @default(now())

  @@index([gatewayId, timestamp])
  @@index([jobType, timestamp])
  @@index([status, timestamp])
  @@index([timestamp])
  @@schema("public")
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("public")
}

// ============================================
// CORE PLATFORM - PLUGIN MANAGEMENT
// ============================================

model WorkflowPlugin {
  id             String   @id @default(uuid())
  name           String   @unique
  displayName    String
  version        String
  remoteUrl      String
  bundleUrl      String?  // CDN UMD bundle URL (e.g., /cdn/plugins/my-wallet/1.0.0/my-wallet.js)
  stylesUrl      String?  // CDN styles URL (e.g., /cdn/plugins/my-wallet/1.0.0/my-wallet.css)
  globalName     String?  // UMD global name (e.g., NaapPluginMyWallet)
  deploymentType String?  @default("cdn") // 'cdn' | 'container'
  routes         String[]
  enabled        Boolean  @default(true)
  order          Int      @default(0)
  icon           String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([enabled, order])
  @@schema("public")
}

model PluginConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

model UserPluginPreference {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pluginName String
  enabled    Boolean  @default(true)
  order      Int?
  pinned     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, pluginName])
  @@index([userId])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - PLUGIN MARKETPLACE
// ============================================

model Publisher {
  id          String          @id @default(uuid())
  name        String          @unique
  displayName String
  description String?
  website     String?
  githubOrg   String?         @unique
  githubUser  String?         @unique
  email       String          @unique
  avatarUrl   String?
  verified    Boolean         @default(false)
  packages    PluginPackage[] @relation("PackagePublisher")
  tokens      ApiToken[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([githubOrg])
  @@index([githubUser])
  @@schema("public")
}

model ApiToken {
  id          String    @id @default(uuid())
  name        String
  tokenHash   String    @unique
  tokenPrefix String
  publisherId String
  publisher   Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  scopes      String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())

  @@index([tokenHash])
  @@index([publisherId])
  @@schema("public")
}

model WebhookSecret {
  id          String   @id @default(uuid())
  publisherId String
  provider    String
  secretHash  String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([publisherId, provider])
  @@schema("public")
}

model PluginPackage {
  id            String               @id @default(uuid())
  name          String               @unique
  displayName   String
  description   String?
  category      String               @default("other")
  author        String?
  authorEmail   String?
  repository    String?
  githubRepo    String?
  license       String?
  keywords      String[]
  icon          String?
  downloads     Int                  @default(0)
  rating        Float?
  deprecated    Boolean              @default(false)
  isCore        Boolean              @default(false)
  publishStatus String               @default("draft")
  publisherId   String?
  publisher     Publisher?           @relation("PackagePublisher", fields: [publisherId], references: [id])
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  versions      PluginVersion[]
  installations PluginInstallation[]
  deployment    PluginDeployment?
  reviews       PluginReview[]

  @@index([category])
  @@index([deprecated])
  @@index([publisherId])
  @@index([publishStatus])
  @@index([isCore])
  @@index([publishStatus, category, deprecated])
  @@schema("public")
}

model PluginVersion {
  id             String               @id @default(uuid())
  packageId      String
  package        PluginPackage        @relation(fields: [packageId], references: [id], onDelete: Cascade)
  version        String
  manifest       Json
  frontendUrl    String?
  backendImage   String?
  releaseNotes   String?
  deprecated     Boolean              @default(false)
  deprecationMsg String?
  downloads      Int                  @default(0)
  publishedAt    DateTime             @default(now())

  // CDN deployment fields (for UMD bundles)
  bundleUrl      String?              // CDN URL for the UMD bundle
  stylesUrl      String?              // CDN URL for styles
  bundleHash     String?              // Content hash for cache validation
  bundleSize     Int?                 // Bundle size in bytes
  deploymentType String?              @default("cdn") // cdn | container

  installations  PluginInstallation[]
  deployments    PluginDeployment[]
  pinnedByTeams  TeamPluginInstall[]  @relation("PinnedVersion")

  @@unique([packageId, version])
  @@index([packageId, publishedAt])
  @@index([deploymentType])
  @@schema("public")
}

model PluginInstallation {
  id              String        @id @default(uuid())
  packageId       String
  package         PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  versionId       String
  version         PluginVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  status          String        @default("pending")
  containerPort   Int?
  databaseName    String?
  frontendPort    Int?
  config          Json?
  installedAt     DateTime?
  lastHealthCheck DateTime?
  healthStatus    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([packageId])
  @@index([status])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - MULTI-TENANT PLUGIN DEPLOYMENT
// ============================================

model PluginDeployment {
  id              String                @id @default(uuid())
  packageId       String                @unique
  package         PluginPackage         @relation(fields: [packageId], references: [id], onDelete: Cascade)
  versionId       String
  version         PluginVersion         @relation(fields: [versionId], references: [id], onDelete: Cascade)
  status          String                @default("pending")
  frontendUrl     String?
  backendUrl      String?
  containerPort   Int?
  databaseSchema  String?

  // CDN deployment fields
  bundleUrl       String?               // CDN URL for UMD bundle
  stylesUrl       String?               // CDN URL for styles
  bundleHash      String?               // Content hash for cache busting
  bundleSize      Int?                  // Bundle size in bytes
  deploymentType  String                @default("cdn") // cdn | container

  activeInstalls  Int                   @default(0)
  deployedAt      DateTime?
  lastHealthCheck DateTime?
  healthStatus    String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  tenantInstalls  TenantPluginInstall[]
  teamInstalls    TeamPluginInstall[]
  slots           PluginDeploymentSlot[]

  @@index([status])
  @@index([healthStatus])
  @@index([deploymentType])
  @@schema("public")
}

model TenantPluginInstall {
  id           String              @id @default(uuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  deploymentId String
  deployment   PluginDeployment    @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  status       String              @default("active")
  installedAt  DateTime            @default(now())
  enabled      Boolean             @default(true)
  order        Int                 @default(0)
  pinned       Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  config       TenantPluginConfig?

  @@unique([userId, deploymentId])
  @@index([userId, status])
  @@index([userId, enabled, order])
  @@index([deploymentId])
  @@schema("public")
}

model TenantPluginConfig {
  id              String              @id @default(uuid())
  tenantInstallId String              @unique
  tenantInstall   TenantPluginInstall @relation(fields: [tenantInstallId], references: [id], onDelete: Cascade)
  settings        Json                @default("{}")
  secrets         Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@schema("public")
}

model TeamPluginInstall {
  id              String                   @id @default(uuid())
  teamId          String
  team            Team                     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  deploymentId    String
  deployment      PluginDeployment         @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  installedBy     String
  status          String                   @default("active")
  enabled         Boolean                  @default(true)
  pinnedVersionId String?
  pinnedVersion   PluginVersion?           @relation("PinnedVersion", fields: [pinnedVersionId], references: [id], onDelete: SetNull)
  sharedConfig    Json?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  memberAccess    TeamMemberPluginAccess[]
  memberConfigs   TeamMemberPluginConfig[]

  @@unique([teamId, deploymentId])
  @@index([teamId])
  @@index([deploymentId])
  @@schema("public")
}

model TeamMemberPluginAccess {
  id              String            @id @default(uuid())
  memberId        String
  member          TeamMember        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pluginInstallId String
  pluginInstall   TeamPluginInstall @relation(fields: [pluginInstallId], references: [id], onDelete: Cascade)
  visible         Boolean           @default(true)
  canUse          Boolean           @default(true)
  canConfigure    Boolean           @default(false)
  pluginRole      String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([memberId, pluginInstallId])
  @@index([memberId])
  @@index([pluginInstallId])
  @@schema("public")
}

model TeamMemberPluginConfig {
  id              String            @id @default(uuid())
  memberId        String
  member          TeamMember        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pluginInstallId String
  pluginInstall   TeamPluginInstall @relation(fields: [pluginInstallId], references: [id], onDelete: Cascade)
  personalConfig  Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([memberId, pluginInstallId])
  @@index([memberId])
  @@index([pluginInstallId])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - INTEGRATIONS
// ============================================

model IntegrationConfig {
  id          String   @id @default(uuid())
  type        String   @unique
  displayName String
  configured  Boolean  @default(false)
  credentials Json?
  options     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("public")
}

model PluginIntegrationPermission {
  id              String    @id @default(uuid())
  pluginName      String
  integrationType String
  granted         Boolean   @default(false)
  grantedAt       DateTime?
  grantedBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([pluginName, integrationType])
  @@index([pluginName])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - SECRETS & SECURITY
// ============================================

model SecretVault {
  id             String    @id @default(uuid())
  key            String    @unique
  encryptedValue String
  iv             String
  description    String?
  scope          String    @default("global")
  createdBy      String?
  rotatedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([scope])
  @@schema("public")
}

model APIKeyMapping {
  id              String   @id @default(uuid())
  pluginName      String
  integrationType String
  secretKey       String
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([pluginName, integrationType])
  @@index([secretKey])
  @@schema("public")
}

// ============================================
// CORE PLATFORM - AUDIT & LIFECYCLE
// ============================================

model PluginLifecycleEvent {
  id          String   @id @default(uuid())
  pluginName  String
  version     String?
  action      String
  fromStatus  String?
  toStatus    String
  initiatedBy String?
  details     Json?
  error       String?
  duration    Int?
  createdAt   DateTime @default(now())

  @@index([pluginName, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@schema("public")
}

model PluginMigration {
  id            String    @id @default(uuid())
  pluginName    String
  version       String
  migrationName String
  status        String    @default("pending")
  appliedAt     DateTime?
  completedAt   DateTime?
  error         String?
  checksum      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([pluginName, migrationName])
  @@index([pluginName, version])
  @@index([status])
  @@schema("public")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  resource   String
  resourceId String?
  userId     String?
  ipAddress  String?
  userAgent  String?
  details    Json?
  status     String   @default("success")
  errorMsg   String?
  createdAt  DateTime @default(now())

  @@index([action, createdAt])
  @@index([resource, resourceId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@schema("public")
}

// ============================================
// PLUGIN: COMMUNITY
// ============================================
// Social features - forums, posts, comments, reputation, badges
// Note: CommunityProfile links to User via userId, NOT a separate User table

model CommunityProfile {
  id         String   @id @default(uuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio        String?
  reputation Int      @default(0)
  level      Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  posts          CommunityPost[]
  comments       CommunityComment[]
  votes          CommunityVote[]
  reputationLogs CommunityReputationLog[]
  badges         CommunityUserBadge[]

  @@index([reputation])
  @@schema("plugin_community")
}

model CommunityPost {
  id               String              @id @default(uuid())
  authorId         String
  author           CommunityProfile    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  title            String
  content          String
  postType         CommunityPostType   @default(DISCUSSION)
  category         CommunityCategory   @default(GENERAL)
  status           CommunityPostStatus @default(OPEN)
  upvotes          Int                 @default(0)
  viewCount        Int                 @default(0)
  commentCount     Int                 @default(0)
  isSolved         Boolean             @default(false)
  acceptedAnswerId String?
  isPinned         Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  comments CommunityComment[]
  votes    CommunityVote[]
  postTags CommunityPostTag[]

  @@index([authorId])
  @@index([category])
  @@index([postType])
  @@index([isSolved])
  @@index([createdAt])
  @@index([upvotes])
  @@schema("plugin_community")
}

enum CommunityPostType {
  QUESTION
  DISCUSSION
  ANNOUNCEMENT
  SHOWCASE

  @@schema("plugin_community")
}

enum CommunityCategory {
  GENERAL
  ORCHESTRATORS
  TRANSCODERS
  AI_PIPELINES
  GOVERNANCE
  TROUBLESHOOTING

  @@schema("plugin_community")
}

enum CommunityPostStatus {
  OPEN
  CLOSED
  ARCHIVED

  @@schema("plugin_community")
}

model CommunityComment {
  id         String           @id @default(uuid())
  postId     String
  post       CommunityPost    @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId   String
  author     CommunityProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content    String
  upvotes    Int              @default(0)
  isAccepted Boolean          @default(false)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  votes CommunityVote[]

  @@index([postId])
  @@index([authorId])
  @@index([isAccepted])
  @@schema("plugin_community")
}

model CommunityVote {
  id         String              @id @default(uuid())
  profileId  String
  profile    CommunityProfile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  targetType CommunityVoteTarget
  targetId   String
  value      Int                 @default(1)
  createdAt  DateTime            @default(now())

  post      CommunityPost?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?
  comment   CommunityComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?

  @@unique([profileId, targetType, targetId])
  @@index([targetType, targetId])
  @@schema("plugin_community")
}

enum CommunityVoteTarget {
  POST
  COMMENT

  @@schema("plugin_community")
}

model CommunityTag {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String   @default("#6b7280")
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())

  postTags CommunityPostTag[]

  @@index([slug])
  @@index([usageCount])
  @@schema("plugin_community")
}

model CommunityPostTag {
  id     String        @id @default(uuid())
  postId String
  post   CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId  String
  tag    CommunityTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@schema("plugin_community")
}

model CommunityReputationLog {
  id         String                    @id @default(uuid())
  profileId  String
  profile    CommunityProfile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  action     CommunityReputationAction
  points     Int
  sourceType String?
  sourceId   String?
  createdAt  DateTime                  @default(now())

  @@index([profileId])
  @@index([createdAt])
  @@schema("plugin_community")
}

enum CommunityReputationAction {
  POST_CREATED
  POST_UPVOTED
  POST_RECEIVED_UPVOTE
  COMMENT_CREATED
  COMMENT_UPVOTED
  COMMENT_RECEIVED_UPVOTE
  ANSWER_ACCEPTED
  QUESTION_SOLVED
  DAILY_LOGIN
  BADGE_EARNED

  @@schema("plugin_community")
}

model CommunityBadge {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String
  icon        String
  color       String   @default("#6b7280")
  criteria    String
  threshold   Int      @default(1)
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges CommunityUserBadge[]

  @@index([slug])
  @@schema("plugin_community")
}

model CommunityUserBadge {
  id        String           @id @default(uuid())
  profileId String
  profile   CommunityProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     CommunityBadge   @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime         @default(now())

  @@unique([profileId, badgeId])
  @@index([profileId])
  @@schema("plugin_community")
}

// ============================================
// PLUGIN: MY WALLET
// ============================================
// Wallet connections, transactions, staking state

model WalletConnection {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address   String
  chainId   Int
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([address])
  @@index([userId])
  @@schema("plugin_wallet")
}

model WalletTransactionLog {
  id          String    @id @default(uuid())
  userId      String
  address     String
  txHash      String    @unique
  type        String
  status      String    @default("pending")
  chainId     Int
  value       String?
  gasUsed     String?
  gasPrice    String?
  blockNumber Int?
  toAddress   String?
  timestamp   DateTime  @default(now())
  confirmedAt DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, timestamp])
  @@index([address, timestamp])
  @@index([txHash])
  @@index([status])
  @@schema("plugin_wallet")
}

model WalletStakingState {
  id             String   @id @default(uuid())
  address        String   @unique
  chainId        Int
  stakedAmount   String   @default("0")
  delegatedTo    String?
  pendingRewards String   @default("0")
  pendingFees    String   @default("0")
  startRound     String?
  lastClaimRound String?
  lastSynced     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([address])
  @@index([delegatedTo])
  @@schema("plugin_wallet")
}

model WalletOrchestrator {
  id         String   @id @default(uuid())
  address    String   @unique
  chainId    Int
  name       String?
  serviceUri String?
  totalStake String   @default("0")
  rewardCut  Int      @default(0)
  feeShare   Int      @default(0)
  isActive   Boolean  @default(true)
  lastSynced DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([chainId, isActive])
  @@index([totalStake])
  @@schema("plugin_wallet")
}

model WalletSettings {
  id             String   @id @default(uuid())
  userId         String   @unique
  defaultNetwork String   @default("arbitrum-one")
  autoConnect    Boolean  @default(true)
  showTestnets   Boolean  @default(false)
  gasStrategy    String   @default("standard")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@schema("plugin_wallet")
}

// ============================================
// PLUGIN: MY DASHBOARD
// ============================================
// Metabase dashboard integration

model Dashboard {
  id          String   @id @default(uuid())
  metabaseId  Int
  entityId    String?
  name        String
  description String?
  thumbnail   String?
  isDefault   Boolean  @default(false)
  order       Int      @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isDefault])
  @@index([order])
  @@index([metabaseId])
  @@schema("plugin_dashboard")
}

model DashboardUserPreference {
  id          String   @id @default(uuid())
  userId      String
  dashboardId String
  pinned      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, dashboardId])
  @@index([userId])
  @@schema("plugin_dashboard")
}

model DashboardPluginConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt

  @@schema("plugin_dashboard")
}

// ============================================
// PLUGIN: DAYDREAM VIDEO
// ============================================
// AI video generation sessions

model DaydreamSettings {
  id             String   @id @default(uuid())
  userId         String   @unique
  apiKey         String?
  defaultPrompt  String   @default("superman")
  defaultSeed    Int      @default(42)
  negativePrompt String   @default("blurry, low quality, flat, 2d")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("daydream_settings")
  @@schema("plugin_daydream")
}

model DaydreamSession {
  id           String    @id @default(uuid())
  userId       String
  streamId     String
  playbackId   String
  whipUrl      String?
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  durationMins Float     @default(0)
  status       String    @default("active")
  prompt       String?
  seed         Int?
  errorMessage String?

  @@index([userId])
  @@index([status])
  @@map("daydream_sessions")
  @@schema("plugin_daydream")
}

// ============================================
// PLUGIN: GATEWAY MANAGER
// ============================================
// Gateway node management and monitoring

model Gateway {
  id                     String   @id @default(uuid())
  address                String   @unique
  operatorName           String
  serviceUri             String
  region                 String
  ip                     String?
  status                 String   @default("online")
  uptime                 Float    @default(100.0)
  latencyP50             Int      @default(0)
  latencyP99             Int      @default(0)
  jobsPerMinute          Int      @default(0)
  deposit                String   @default("0")
  reserve                String   @default("0")
  supportedPipelines     String[] @default([])
  connectedOrchestrators Int      @default(0)
  version                String
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  orchestratorConnections GatewayOrchestratorConnection[]
  performanceMetrics      GatewayPerformanceMetric[]
  configurations          GatewayConfig[]

  @@index([status])
  @@index([region])
  @@index([address])
  @@schema("plugin_gateway")
}

model GatewayOrchestratorConnection {
  id                  String   @id @default(uuid())
  gatewayId           String
  gateway             Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  orchestratorAddress String
  latencyScore        Float
  successRate         Float
  jobsSent            Int      @default(0)
  price               String
  status              String   @default("active")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([gatewayId, orchestratorAddress])
  @@index([gatewayId])
  @@index([orchestratorAddress])
  @@schema("plugin_gateway")
}

model GatewayPerformanceMetric {
  id        String   @id @default(uuid())
  gatewayId String
  gateway   Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  metric    String
  value     Float
  timestamp DateTime @default(now())
  metadata  Json?

  @@index([gatewayId, timestamp])
  @@index([timestamp])
  @@schema("plugin_gateway")
}

model GatewayConfig {
  id            String   @id @default(uuid())
  gatewayId     String   @unique
  gateway       Gateway  @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  slaConfig     Json?
  pricingConfig Json?
  networkConfig Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("plugin_gateway")
}

// ============================================
// PLUGIN: CAPACITY PLANNER
// ============================================
// GPU capacity requests, soft commits, comments

model CapacityRequest {
  id               String                @id @default(uuid())
  requesterName    String
  requesterAccount String
  gpuModel         String
  vram             Int
  osVersion        String                @default("Any")
  cudaVersion      String                @default("Any")
  count            Int
  pipeline         String
  startDate        DateTime
  endDate          DateTime
  validUntil       DateTime
  hourlyRate       Float
  reason           String
  riskLevel        Int                   @default(3)
  status           CapacityRequestStatus @default(ACTIVE)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  softCommits CapacitySoftCommit[]
  comments    CapacityRequestComment[]

  @@index([gpuModel])
  @@index([pipeline])
  @@index([status])
  @@index([validUntil])
  @@index([createdAt])
  @@index([riskLevel])
  @@schema("plugin_capacity")
}

enum CapacityRequestStatus {
  ACTIVE
  EXPIRED
  FULFILLED
  CANCELLED

  @@schema("plugin_capacity")
}

model CapacitySoftCommit {
  id        String          @id @default(uuid())
  requestId String
  request   CapacityRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  userId    String
  userName  String
  gpuCount  Int             @default(1)
  createdAt DateTime        @default(now())

  @@unique([requestId, userId])
  @@index([requestId])
  @@index([userId])
  @@schema("plugin_capacity")
}

model CapacityRequestComment {
  id        String          @id @default(uuid())
  requestId String
  request   CapacityRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  author    String
  text      String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([requestId])
  @@index([createdAt])
  @@schema("plugin_capacity")
}

// ============================================
// PLUGIN: DEVELOPER API
// ============================================
// AI model catalog, gateway offers, API keys, usage tracking

model DevApiAIModel {
  id            String   @id @default(uuid())
  name          String   @unique
  tagline       String
  type          String
  featured      Boolean  @default(false)
  realtime      Boolean  @default(false)
  costPerMinMin Float    @default(0)
  costPerMinMax Float    @default(0)
  latencyP50    Int      @default(0)
  coldStart     Int      @default(0)
  fps           Int      @default(0)
  useCases      String[] @default([])
  badges        String[] @default([])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  gatewayOffers DevApiGatewayOffer[]
  apiKeys       DevApiKey[]

  @@index([type])
  @@index([featured])
  @@index([realtime])
  @@schema("plugin_developer_api")
}

model DevApiGatewayOffer {
  id           String        @id @default(uuid())
  modelId      String
  model        DevApiAIModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  gatewayId    String
  gatewayName  String
  price        Float
  latency      Int
  availability Float         @default(99.0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([modelId, gatewayId])
  @@index([modelId])
  @@index([gatewayId])
  @@schema("plugin_developer_api")
}

model DevApiProject {
  id        String   @id @default(uuid())
  userId    String
  name      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKeys DevApiKey[]

  @@unique([userId, name])
  @@index([userId])
  @@schema("plugin_developer_api")
}

model DevApiKey {
  id                String              @id @default(uuid())
  userId            String
  projectId         String?
  project           DevApiProject?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  billingProviderId String?
  billingProvider   BillingProvider?    @relation(fields: [billingProviderId], references: [id], onDelete: Restrict)
  modelId           String?
  model             DevApiAIModel?      @relation(fields: [modelId], references: [id], onDelete: Cascade)
  keyLookupId       String?             @unique
  keyPrefix         String
  label             String?
  projectName       String?
  keyHash           String?             @unique
  status            DevApiKeyStatus     @default(ACTIVE)
  createdAt         DateTime            @default(now())
  lastUsedAt        DateTime?
  revokedAt         DateTime?

  usageLogs DevApiUsageLog[]

  @@index([userId])
  @@index([projectId])
  @@index([billingProviderId])
  @@index([modelId])
  @@index([status])
  @@index([keyHash])
  @@index([keyLookupId])
  @@schema("plugin_developer_api")
}

enum DevApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED

  @@schema("plugin_developer_api")
}

model DevApiUsageLog {
  id           String    @id @default(uuid())
  apiKeyId     String
  apiKey       DevApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  requestCount Int       @default(1)
  tokensUsed   Int       @default(0)
  costIncurred Float     @default(0)
  timestamp    DateTime  @default(now())

  @@index([apiKeyId])
  @@index([timestamp])
  @@schema("plugin_developer_api")
}

// ============================================
// PLATFORM - PLUGIN REVIEWS
// ============================================

model PluginReview {
  id          String        @id @default(uuid())
  packageId   String
  package     PluginPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating      Int           // 1-5 star rating
  comment     String?       // Optional review comment
  displayName String?       // Cached display name at time of review
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([packageId, userId]) // One review per user per plugin
  @@index([packageId, createdAt])
  @@index([userId])
  @@schema("public")
}

// ============================================
// PLATFORM - FEEDBACK
// ============================================

model Feedback {
  id          String   @id @default(uuid())
  type        String   // bug, feature, general
  title       String
  description String
  status      String   @default("open") // open, investigating, roadmap, released, closed
  releaseTag  String?  // e.g. "v1.2.0" â€“ set when status = released
  adminNote   String?  // internal admin note
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userEmail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("feedback")
  @@schema("public")
}

model FeedbackConfig {
  id             String   @id @default(uuid())
  githubIssueUrl String   @default("")
  discordUrl     String   @default("")
  updatedBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("feedback_config")
  @@schema("public")
}

// ============================================
// PLATFORM - BLUE-GREEN DEPLOYMENT INFRASTRUCTURE
// ============================================

// Deployment slot for blue-green deployments
// Each deployment has two slots (blue/green) for zero-downtime updates
model PluginDeploymentSlot {
  id              String           @id @default(uuid())
  deploymentId    String
  deployment      PluginDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  slot            String           // "blue" | "green"
  version         String           // Version deployed to this slot
  status          String           @default("inactive") // active, inactive, deploying, failed, draining
  trafficPercent  Int              @default(0) // 0-100
  frontendUrl     String?          // CDN URL for this slot's frontend bundle
  backendUrl      String?          // Container URL for this slot's backend
  healthStatus    String?          // healthy, unhealthy, unknown
  lastHealthCheck DateTime?
  healthCheckFailures Int          @default(0)
  deployedAt      DateTime?
  deployedBy      String?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([deploymentId, slot])
  @@index([deploymentId])
  @@index([status])
  @@index([healthStatus])
  @@schema("public")
}

// Deployment events for audit trail and history
model DeploymentEvent {
  id             String   @id @default(uuid())
  deploymentId   String
  type           String   // deploy_start, deploy_complete, health_check, traffic_shift, rollback, failure
  fromSlot       String?
  toSlot         String?
  fromVersion    String?
  toVersion      String?
  trafficPercent Int?
  status         String   @default("success") // success, failure, in_progress
  error          String?
  initiatedBy    String?
  metadata       Json?
  duration       Int?     // Duration in milliseconds
  createdAt      DateTime @default(now())

  @@index([deploymentId])
  @@index([type])
  @@index([createdAt])
  @@index([deploymentId, createdAt])
  @@schema("public")
}

// ============================================
// PLATFORM - PLUGIN OBSERVABILITY
// ============================================

// Time-series metrics for plugin monitoring
model PluginMetrics {
  id             String   @id @default(uuid())
  deploymentId   String
  slot           String?  // Optional slot identifier for per-slot metrics
  timestamp      DateTime @default(now())
  requestCount   Int      @default(0)
  errorCount     Int      @default(0)
  latencyP50     Float?
  latencyP95     Float?
  latencyP99     Float?
  latencyAvg     Float?
  activeUsers    Int      @default(0)
  uniqueSessions Int      @default(0)
  memoryUsageMb  Float?
  cpuUsagePercent Float?
  periodSeconds  Int      @default(60) // Aggregation window

  @@index([deploymentId, timestamp])
  @@index([deploymentId, slot, timestamp])
  @@index([timestamp])
  @@schema("public")
}

// Alert configuration for plugin monitoring
model PluginAlert {
  id              String    @id @default(uuid())
  deploymentId    String
  name            String
  description     String?
  metric          String    // error_rate, latency_p99, health_check, cpu_usage, memory_usage
  operator        String    // gt, gte, lt, lte, eq
  threshold       Float
  duration        Int       @default(60)
  severity        String    @default("warning") // critical, warning, info
  autoRollback    Boolean   @default(false)
  channels        Json      @default("[]")
  enabled         Boolean   @default(true)
  lastTriggeredAt DateTime?
  lastResolvedAt  DateTime?
  triggerCount    Int       @default(0)
  cooldownSeconds Int       @default(300)
  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([deploymentId, name])
  @@index([deploymentId])
  @@index([enabled])
  @@index([severity])
  @@schema("public")
}
