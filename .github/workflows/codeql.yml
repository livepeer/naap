# ---------------------------------------------------------------------------
# CodeQL static analysis for JavaScript / TypeScript
# Only surfaces critical & high-severity security findings.
# Quality / style / low-severity rules are intentionally excluded to reduce
# noise — those concerns are handled by ESLint and PR review.
# ---------------------------------------------------------------------------
name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly scan on Monday at 04:00 UTC
    - cron: '0 4 * * 1'

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          # Default suite = core security queries only (no quality/style rules).
          # Omitting the 'queries' key uses the built-in "security-extended"
          # suite which covers OWASP Top-10, CWE-25, injection, SSRF, etc.
          config: |
            paths-ignore:
              # Example plugins — community samples, not production code
              - examples
              # Test files — intentionally exercise edge cases
              - '**/__tests__'
              - '**/*.test.ts'
              - '**/*.test.tsx'
              - '**/*.spec.ts'
              # Plugin publisher test routes (test harness, not production)
              - apps/web-next/src/app/api/v1/plugin-publisher/test
              - apps/web-next/src/app/api/v1/plugin-publisher/test-backend
              - apps/web-next/src/app/api/v1/plugin-publisher/test-frontend
            query-filters:
              # Keep only critical and high severity findings
              - include:
                  problem.severity:
                    - error
                    - warning
              # Exclude low-severity / informational rules
              - exclude:
                  problem.severity:
                    - recommendation
                    - note

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:${{ matrix.language }}'
